!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t||self).SwupFragmentPlugin=e()}(this,function(){function t(){return t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},t.apply(this,arguments)}const e=t=>String(t).split(".").map(t=>String(parseInt(t||"0",10))).concat(["0","0"]).slice(0,3).join(".");class r{constructor(){this.isSwupPlugin=!0,this.swup=void 0,this.version=void 0,this.requires={},this.handlersToUnregister=[]}mount(){}unmount(){this.handlersToUnregister.forEach(t=>t()),this.handlersToUnregister=[]}_beforeMount(){if(!this.name)throw new Error("You must define a name of plugin when creating a class.")}_afterUnmount(){}_checkRequirements(){return"object"!=typeof this.requires||Object.entries(this.requires).forEach(([t,r])=>{if(!function(t,r,n){const o=function(t,e){var r;if("swup"===t)return null!=(r=e.version)?r:"";{var n;const r=e.findPlugin(t);return null!=(n=null==r?void 0:r.version)?n:""}}(t,n);return!!o&&((t,r)=>r.every(r=>{const[,n,o]=r.match(/^([\D]+)?(.*)$/)||[];var i,s;return((t,e)=>{const r={"":t=>0===t,">":t=>t>0,">=":t=>t>=0,"<":t=>t<0,"<=":t=>t<=0};return(r[e]||r[""])(t)})((s=o,i=e(i=t),s=e(s),i.localeCompare(s,void 0,{numeric:!0})),n||">=")}))(o,r)}(t,r=Array.isArray(r)?r:[r],this.swup)){const e=`${t} ${r.join(", ")}`;throw new Error(`Plugin version mismatch: ${this.name} requires ${e}`)}}),!0}on(t,e,r={}){var n;e=!(n=e).name.startsWith("bound ")||n.hasOwnProperty("prototype")?e.bind(this):e;const o=this.swup.hooks.on(t,e,r);return this.handlersToUnregister.push(o),o}once(e,r,n={}){return this.on(e,r,t({},n,{once:!0}))}before(e,r,n={}){return this.on(e,r,t({},n,{before:!0}))}replace(e,r,n={}){return this.on(e,r,t({},n,{replace:!0}))}off(t,e){return this.swup.hooks.off(t,e)}}function n(t,e){var r=[];return function(t,e,r){void 0===r&&(r={});var n=r.decode,o=void 0===n?function(t){return t}:n;return function(r){var n=t.exec(r);if(!n)return!1;for(var i=n[0],s=n.index,a=Object.create(null),c=function(t){if(void 0===n[t])return"continue";var r=e[t-1];a[r.name]="*"===r.modifier||"+"===r.modifier?n[t].split(r.prefix+r.suffix).map(function(t){return o(t,r)}):o(n[t],r)},u=1;u<n.length;u++)c(u);return{path:i,index:s,params:a}}}(s(t,r,e),r,e)}function o(t){return t.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function i(t){return t&&t.sensitive?"":"i"}function s(t,e,r){return t instanceof RegExp?function(t,e){if(!e)return t;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,n=0,o=r.exec(t.source);o;)e.push({name:o[1]||n++,prefix:"",suffix:"",modifier:"",pattern:""}),o=r.exec(t.source);return t}(t,e):Array.isArray(t)?function(t,e,r){var n=t.map(function(t){return s(t,e,r).source});return new RegExp("(?:".concat(n.join("|"),")"),i(r))}(t,e,r):function(t,e,r){return function(t,e,r){void 0===r&&(r={});for(var n=r.strict,s=void 0!==n&&n,a=r.start,c=void 0===a||a,u=r.end,l=void 0===u||u,f=r.encode,h=void 0===f?function(t){return t}:f,g=r.delimiter,m=void 0===g?"/#?":g,p=r.endsWith,d="[".concat(o(void 0===p?"":p),"]|$"),w="[".concat(o(m),"]"),v=c?"^":"",y=0,E=t;y<E.length;y++){var x=E[y];if("string"==typeof x)v+=o(h(x));else{var S=o(h(x.prefix)),b=o(h(x.suffix));if(x.pattern)if(e&&e.push(x),S||b)if("+"===x.modifier||"*"===x.modifier){var R="*"===x.modifier?"?":"";v+="(?:".concat(S,"((?:").concat(x.pattern,")(?:").concat(b).concat(S,"(?:").concat(x.pattern,"))*)").concat(b,")").concat(R)}else v+="(?:".concat(S,"(").concat(x.pattern,")").concat(b,")").concat(x.modifier);else{if("+"===x.modifier||"*"===x.modifier)throw new TypeError('Can not repeat "'.concat(x.name,'" without a prefix and suffix'));v+="(".concat(x.pattern,")").concat(x.modifier)}else v+="(?:".concat(S).concat(b,")").concat(x.modifier)}}if(l)s||(v+="".concat(w,"?")),v+=r.endsWith?"(?=".concat(d,")"):"$";else{var $=t[t.length-1],A="string"==typeof $?w.indexOf($[$.length-1])>-1:void 0===$;s||(v+="(?:".concat(w,"(?=").concat(d,"))?")),A||(v+="(?=".concat(w,"|").concat(d,")"))}return new RegExp(v,i(r))}(function(t,e){void 0===e&&(e={});for(var r=function(t){for(var e=[],r=0;r<t.length;){var n=t[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)e.push({type:"CHAR",index:r,value:t[r++]});else{var o=1,i="";if("?"===t[a=r+1])throw new TypeError('Pattern cannot start with "?" at '.concat(a));for(;a<t.length;)if("\\"!==t[a]){if(")"===t[a]){if(0===--o){a++;break}}else if("("===t[a]&&(o++,"?"!==t[a+1]))throw new TypeError("Capturing groups are not allowed at ".concat(a));i+=t[a++]}else i+=t[a++]+t[a++];if(o)throw new TypeError("Unbalanced pattern at ".concat(r));if(!i)throw new TypeError("Missing pattern at ".concat(r));e.push({type:"PATTERN",index:r,value:i}),r=a}else{for(var s="",a=r+1;a<t.length;){var c=t.charCodeAt(a);if(!(c>=48&&c<=57||c>=65&&c<=90||c>=97&&c<=122||95===c))break;s+=t[a++]}if(!s)throw new TypeError("Missing parameter name at ".concat(r));e.push({type:"NAME",index:r,value:s}),r=a}else e.push({type:"CLOSE",index:r,value:t[r++]});else e.push({type:"OPEN",index:r,value:t[r++]});else e.push({type:"ESCAPED_CHAR",index:r++,value:t[r++]});else e.push({type:"MODIFIER",index:r,value:t[r++]})}return e.push({type:"END",index:r,value:""}),e}(t),n=e.prefixes,i=void 0===n?"./":n,s=e.delimiter,a=void 0===s?"/#?":s,c=[],u=0,l=0,f="",h=function(t){if(l<r.length&&r[l].type===t)return r[l++].value},g=function(t){var e=h(t);if(void 0!==e)return e;var n=r[l],o=n.index;throw new TypeError("Unexpected ".concat(n.type," at ").concat(o,", expected ").concat(t))},m=function(){for(var t,e="";t=h("CHAR")||h("ESCAPED_CHAR");)e+=t;return e},p=function(t){var e=c[c.length-1],r=t||(e&&"string"==typeof e?e:"");if(e&&!r)throw new TypeError('Must have text between two parameters, missing text after "'.concat(e.name,'"'));return!r||function(t){for(var e=0,r=a;e<r.length;e++)if(t.indexOf(r[e])>-1)return!0;return!1}(r)?"[^".concat(o(a),"]+?"):"(?:(?!".concat(o(r),")[^").concat(o(a),"])+?")};l<r.length;){var d=h("CHAR"),w=h("NAME"),v=h("PATTERN");if(w||v)-1===i.indexOf(E=d||"")&&(f+=E,E=""),f&&(c.push(f),f=""),c.push({name:w||u++,prefix:E,suffix:"",pattern:v||p(E),modifier:h("MODIFIER")||""});else{var y=d||h("ESCAPED_CHAR");if(y)f+=y;else if(f&&(c.push(f),f=""),h("OPEN")){var E=m(),x=h("NAME")||"",S=h("PATTERN")||"",b=m();g("CLOSE"),c.push({name:x||(S?u++:""),pattern:x&&!S?p(E):S,prefix:E,suffix:b,modifier:h("MODIFIER")||""})}else g("END")}}return c}(t,r),e,r)}(t,e,r)}class a extends URL{constructor(t,e=document.baseURI){super(t.toString(),e),Object.setPrototypeOf(this,a.prototype)}get url(){return this.pathname+this.search}static fromElement(t){const e=t.getAttribute("href")||t.getAttribute("xlink:href")||"";return new a(e)}static fromUrl(t){return new a(t)}}const c=(t,e)=>{Array.isArray(t)&&!t.length&&(t="");try{return n(t,e)}catch(e){throw new Error(`[swup] Error parsing path "${String(t)}":\n${String(e)}`)}};window.process||(window.process={}),window.process.env||(window.process.env={});const u=["test"].includes(String("production")),l=["development","test"].includes(String("production")),f=(t,e,r)=>null==t?t:`[${e}m${String(t)}[${r}m`,h=t=>u?t:`ðŸ§© ${(t=>f(t,1,22))(t)}`,g=t=>u?t:(t=>f(t,94,39))(t);class m{log(){var t=[].slice.call(arguments);const e=t.shift();console.log(h(e),...t)}warn(){var t=[].slice.call(arguments);const e=t.shift();console.warn(h(e),...t)}error(){var t=[].slice.call(arguments);const e=t.shift();console.error(h(e),...t)}logIf(t){t&&this.log(...[].slice.call(arguments,1))}warnIf(t){t&&this.warn(...[].slice.call(arguments,1))}errorIf(t){t&&this.error(...[].slice.call(arguments,1))}}const p=t=>{!function({parsedRules:t,swup:e,logger:r}){const n=e.getCurrentUrl();t.filter(t=>t.matchesFrom(n)||t.matchesTo(n)).forEach(t=>{t.containers.forEach(t=>{const o=b(`${t}:not([data-swup-fragment])`,e);if(!o)return;const i=o.getAttribute("data-swup-fragment-url");i&&l&&r?.log(`fragment url ${g(i)} for ${g(t)} provided by server`);const{url:s}=a.fromUrl(i||n);o.setAttribute("data-swup-fragment",""),o.__swupFragment={url:s,selector:t}})})}(t),function({logger:t,swup:e}){const r="data-swup-link-to-fragment";document.querySelectorAll(`a[${r}]`).forEach(n=>{const o=n.getAttribute(r);if(!o)return void(l&&t?.warn(`[${r}] needs to contain a valid fragment selector`));const i=b(o,e);if(!i)return void(l&&t?.log(`ignoring ${g(`[${r}="${o}"]`)} as ${g(o)} is missing`));const s=i.__swupFragment?.url;s?(w(s,e.getCurrentUrl())&&l&&t?.warn(`The fragment URL of ${o} is identical to the current URL. This could mean that [data-swup-fragment-url] needs to be provided by the server.`),n.href=s):l&&t?.warn(`no fragment infos found on ${o}`)})}(t),function({logger:t}){document.querySelectorAll("dialog[data-swup-fragment][open]").forEach(e=>{e.__swupFragment?e.__swupFragment.modalShown||(e.__swupFragment.modalShown=!0,e.removeAttribute("open"),e.showModal?.(),e.addEventListener("keydown",t=>"Escape"===t.key&&t.preventDefault())):l&&t?.warn("fragment properties missing on element:",e)})}(t)},d=(t,e)=>{const r=t.__swupFragment?.url;return!!r&&w(r,e)},w=(t,e)=>v(t)===v(e),v=t=>{if(!t.trim())return t;const e=a.fromUrl(t);return e.searchParams.sort(),e.pathname.replace(/\/+$/g,"")+e.search},y=t=>{const e=t.from.url,r=t.to.url;if(e&&r)return{from:e,to:r}},E=(t,e)=>{if(!t?.name)return;const{name:r,containers:n}=t;n.forEach(t=>{document.querySelector(t)?.classList.toggle(`to-${r}`,e)})},x=(t,e,r)=>e.find(e=>e.matches(t,r));function S(t){return!!t&&t.containers.every(t=>"template"===document.querySelector(t)?.tagName?.toLowerCase())}function b(t,e){for(const r of e.options.containers){const e=document.querySelector(r);if(e?.matches(t))return e;const n=e?.querySelector(t);if(n)return n}}function R(t){if(!Array.isArray(t))throw new Error("cloneRules() expects an array of rules");return t.map(t=>({...t,from:Array.isArray(t.from)?[...t.from]:t.from,to:Array.isArray(t.to)?[...t.to]:t.to,containers:[...t.containers]}))}class ${constructor(t){this.matchesFrom=void 0,this.matchesTo=void 0,this.swup=void 0,this.from=void 0,this.to=void 0,this.containers=void 0,this.name=void 0,this.scroll=!1,this.focus=void 0,this.logger=void 0,this.if=()=>!0,this.swup=t.swup,this.logger=t.logger,this.from=t.from||"",this.to=t.to||"",t.name&&(this.name=String(t.name).toLowerCase().replace(/[\s/_.]+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,"")||""),void 0!==t.scroll&&(this.scroll=t.scroll),void 0!==t.focus&&(this.focus=t.focus),"function"==typeof t.if&&(this.if=t.if),this.containers=this.parseContainers(t.containers),l&&(this.logger?.errorIf(!this.to,"Every fragment rule must contain a 'to' path",this),this.logger?.errorIf(!this.from,"Every fragment rule must contain a 'from' path",this)),this.matchesFrom=c(this.from),this.matchesTo=c(this.to)}parseContainers(t){return Array.isArray(t)&&t.length?(e=t.map(t=>t.trim()),[...new Set(e)]).filter(t=>{const e=this.validateSelector(t);return this.logger?.errorIf(e instanceof Error,e),!0===e}):(l&&this.logger?.error("Every fragment rule must contain an array of containers",this.getDebugInfo()),[]);var e}validateSelector(t){return t.startsWith("#")?!t.match(/\s|>/)||new Error(`fragment selectors must not be nested: ${t}`):new Error(`fragment selectors must be IDs: ${t}`)}getDebugInfo(){const{from:t,to:e,containers:r}=this;return{from:String(t),to:String(e),containers:String(r)}}matches(t,e){if(!this.if(e))return l&&this.logger?.log("ignoring fragment rule due to custom rule.if:",this),!1;const{url:r}=a.fromUrl(t.from),{url:n}=a.fromUrl(t.to);if(!this.matchesFrom(r)||!this.matchesTo(n))return!1;for(const t of this.containers){const e=this.validateFragmentSelectorForMatch(t);if(e instanceof Error)return l&&this.logger?.error(e,this.getDebugInfo()),!1}return!0}validateFragmentSelectorForMatch(t){return document.querySelector(t)?!!b(t,this.swup)||new Error(`skipping rule since ${g(t)} is outside of swup's default containers`):new Error(`skipping rule since ${g(t)} doesn't exist in the current document`)}}const A=function(t){const e=y(t);e&&x(e,this.parsedRules,t)&&(t.scroll.reset=!1)},_=function(t){try{const e=this,r=y(t);if(!r)return Promise.resolve();const n=e.getFragmentVisit(r,t);if(!n)return Promise.resolve();t.fragmentVisit=n,l&&e.logger?.log(`fragment visit: ${g(t.fragmentVisit.containers.join(", "))}`),t.scroll=function(t,e){return"boolean"==typeof t.scroll?{...e,reset:t.scroll}:"string"!=typeof t.scroll||e.target?e:{...e,target:t.scroll}}(n,t.scroll);const o=t.a11y;return void 0!==n.focus&&(l&&e.logger?.errorIf(!o,"Can't set visit.a11y.focus. Is @swup/a11y-plugin installed?"),o&&(o.focus=n.focus)),t.animation.scope=t.fragmentVisit.containers,t.containers=t.fragmentVisit.containers,t.animation.selector=t.fragmentVisit.containers.join(","),E(n,!0),Promise.resolve()}catch(t){return Promise.reject(t)}},F=function(t,e){t.fragmentVisit&&S(t.fragmentVisit)&&(l&&this.logger?.log(`${g("out")}-animation skipped for ${g(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},T=function(t,e){t.fragmentVisit&&S(t.fragmentVisit)&&(l&&this.logger?.log(`${g("in")}-animation skipped for ${g(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},P=function(t,e){if(t.trigger.el||!t.to.url)return;const r=this.swup.cache.get(t.to.url);r&&r.fragmentHtml&&(t.to.document=(new DOMParser).parseFromString(r.fragmentHtml,"text/html"),t.to.html=r.fragmentHtml,l&&this.logger?.log(`fragment cache used for ${g(t.to.url)}`))},C=function(t){E(t.fragmentVisit,!0),p(this),(({swup:t,logger:e})=>{const r=t.getCurrentUrl(),n=t.cache,o=n.get(r);if(!o)return;const i=(new DOMParser).parseFromString(o.html,"text/html"),s=[],a=Array.from(document.querySelectorAll("[data-swup-fragment]")).filter(t=>!t.matches("template")&&!d(t,r));a.length&&(t.options.cache?(a.forEach(t=>{if(null!=t.querySelector("[data-swup-fragment]"))return;const r=t.__swupFragment?.url;if(!r)return void(l&&e?.warn("no fragment url found:",t));const o=t.__swupFragment?.selector;if(!o)return void(l&&e?.warn("no fragment selector found:",t));const a=n.get(r);if(!a)return;const c=i.querySelector(o);if(!c)return;const u=(new DOMParser).parseFromString(a.html,"text/html").querySelector(o);u&&(u.setAttribute("data-swup-fragment-url",r),c.replaceWith(u),s.push(t))}),s.length&&(n.update(r,{fragmentHtml:i.documentElement.outerHTML}),s.forEach(t=>{const r=t.__swupFragment?.url||"",n=t.__swupFragment?.selector||"";l&&e?.log(`updated cache with ${g(n)} from ${g(r)}`)}))):l&&e?.warn("can't cache foreign fragment elements without swup's cache"))})(this)},O=function(t){E(t.fragmentVisit,!1)};return class extends r{get parsedRules(){return this._parsedRules}constructor(t){super(),this.name="SwupFragmentPlugin",this.requires={swup:">=4.6"},this._rawRules=[],this._parsedRules=[],this.options=void 0,this.defaults={rules:[],debug:!1},this.logger=void 0,this.options={...this.defaults,...t}}mount(){const t=this.swup;this.setRules(this.options.rules),l&&this.options.debug&&(this.logger=new m),this.before("link:self",A),this.on("visit:start",_),this.before("animation:out:await",F),this.before("animation:in:await",T),this.before("content:replace",P),this.on("content:replace",C),this.on("visit:end",O),l&&this.logger?.warnIf(!t.options.cache,"fragment caching will only work with swup's cache being active"),p(this)}unmount(){super.unmount(),document.querySelectorAll("[data-swup-fragment]").forEach(t=>{t.removeAttribute("data-swup-fragment-url"),delete t.__swupFragment})}setRules(t){this._rawRules=R(t),this._parsedRules=t.map(t=>this.parseRule(t)),l&&this.logger?.log("Updated fragment rules",this.getRules())}getRules(){return R(this._rawRules)}prependRule(t){this.setRules([t,...this.getRules()])}appendRule(t){this.setRules([...this.getRules(),t])}parseRule(t){return new $({...t,logger:this.logger,swup:this.swup})}getFragmentVisit(t,e){const r=x(t,this.parsedRules,e||this.swup.createVisit(t));if(!r)return;const n=((t,e,r,n)=>{let o=e.map(t=>{const e=document.querySelector(t);return e?b(t,r)?{selector:t,el:e}:(l&&n?.error(`${g(t)} is outside of swup's default containers`),!1):(l&&n?.log(`${g(t)} missing in current document`),!1)}).filter(t=>!!t);const i=o.every(e=>d(e.el,t.to));return w(t.from,t.to)||i&&"navigate"===r.options.linkToSelf||(o=o.filter(e=>!d(e.el,t.to)||(l&&n?.log(`ignoring fragment ${g(e.selector)} as it already matches the current URL`),!1))),o.map(t=>t.selector)})(t,r.containers,this.swup,this.logger);if(!n.length)return;const{name:o,scroll:i,focus:s}=r;return{containers:n,name:o,scroll:i,focus:s}}}});
//# sourceMappingURL=index.umd.js.map
