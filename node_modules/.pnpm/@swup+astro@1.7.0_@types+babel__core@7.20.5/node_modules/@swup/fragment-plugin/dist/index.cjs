var t=require("@swup/plugin"),e=require("swup");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=/*#__PURE__*/r(t);window.process||(window.process={}),window.process.env||(window.process.env={});const o=["test"].includes(String(process.env.NODE_ENV)),n=["development","test"].includes(String(process.env.NODE_ENV)),i=(t,e,r)=>null==t?t:`[${e}m${String(t)}[${r}m`,a=t=>o?t:`ðŸ§© ${(t=>i(t,1,22))(t)}`,l=t=>o?t:(t=>i(t,94,39))(t);class c{log(){var t=[].slice.call(arguments);const e=t.shift();console.log(a(e),...t)}warn(){var t=[].slice.call(arguments);const e=t.shift();console.warn(a(e),...t)}error(){var t=[].slice.call(arguments);const e=t.shift();console.error(a(e),...t)}logIf(t){t&&this.log(...[].slice.call(arguments,1))}warnIf(t){t&&this.warn(...[].slice.call(arguments,1))}errorIf(t){t&&this.error(...[].slice.call(arguments,1))}}const u=t=>{!function({parsedRules:t,swup:r,logger:s}){const o=r.getCurrentUrl();t.filter(t=>t.matchesFrom(o)||t.matchesTo(o)).forEach(t=>{t.containers.forEach(t=>{const i=v(`${t}:not([data-swup-fragment])`,r);if(!i)return;const a=i.getAttribute("data-swup-fragment-url");a&&n&&s?.log(`fragment url ${l(a)} for ${l(t)} provided by server`);const{url:c}=e.Location.fromUrl(a||o);i.setAttribute("data-swup-fragment",""),i.__swupFragment={url:c,selector:t}})})}(t),function({logger:t,swup:e}){const r="data-swup-link-to-fragment";document.querySelectorAll(`a[${r}]`).forEach(s=>{const o=s.getAttribute(r);if(!o)return void(n&&t?.warn(`[${r}] needs to contain a valid fragment selector`));const i=v(o,e);if(!i)return void(n&&t?.log(`ignoring ${l(`[${r}="${o}"]`)} as ${l(o)} is missing`));const a=i.__swupFragment?.url;a?(f(a,e.getCurrentUrl())&&n&&t?.warn(`The fragment URL of ${o} is identical to the current URL. This could mean that [data-swup-fragment-url] needs to be provided by the server.`),s.href=a):n&&t?.warn(`no fragment infos found on ${o}`)})}(t),function({logger:t}){document.querySelectorAll("dialog[data-swup-fragment][open]").forEach(e=>{e.__swupFragment?e.__swupFragment.modalShown||(e.__swupFragment.modalShown=!0,e.removeAttribute("open"),e.showModal?.(),e.addEventListener("keydown",t=>"Escape"===t.key&&t.preventDefault())):n&&t?.warn("fragment properties missing on element:",e)})}(t)},g=(t,e)=>{const r=t.__swupFragment?.url;return!!r&&f(r,e)},f=(t,e)=>m(t)===m(e),m=t=>{if(!t.trim())return t;const r=e.Location.fromUrl(t);return r.searchParams.sort(),r.pathname.replace(/\/+$/g,"")+r.search},h=t=>{const e=t.from.url,r=t.to.url;if(e&&r)return{from:e,to:r}},p=(t,e)=>{if(!t?.name)return;const{name:r,containers:s}=t;s.forEach(t=>{document.querySelector(t)?.classList.toggle(`to-${r}`,e)})},d=(t,e,r)=>e.find(e=>e.matches(t,r));function w(t){return!!t&&t.containers.every(t=>"template"===document.querySelector(t)?.tagName?.toLowerCase())}function v(t,e){for(const r of e.options.containers){const e=document.querySelector(r);if(e?.matches(t))return e;const s=e?.querySelector(t);if(s)return s}}function y(t){if(!Array.isArray(t))throw new Error("cloneRules() expects an array of rules");return t.map(t=>({...t,from:Array.isArray(t.from)?[...t.from]:t.from,to:Array.isArray(t.to)?[...t.to]:t.to,containers:[...t.containers]}))}class S{constructor(t){this.matchesFrom=void 0,this.matchesTo=void 0,this.swup=void 0,this.from=void 0,this.to=void 0,this.containers=void 0,this.name=void 0,this.scroll=!1,this.focus=void 0,this.logger=void 0,this.if=()=>!0,this.swup=t.swup,this.logger=t.logger,this.from=t.from||"",this.to=t.to||"",t.name&&(this.name=e.classify(t.name)),void 0!==t.scroll&&(this.scroll=t.scroll),void 0!==t.focus&&(this.focus=t.focus),"function"==typeof t.if&&(this.if=t.if),this.containers=this.parseContainers(t.containers),n&&(this.logger?.errorIf(!this.to,"Every fragment rule must contain a 'to' path",this),this.logger?.errorIf(!this.from,"Every fragment rule must contain a 'from' path",this)),this.matchesFrom=e.matchPath(this.from),this.matchesTo=e.matchPath(this.to)}parseContainers(t){return Array.isArray(t)&&t.length?(e=t.map(t=>t.trim()),[...new Set(e)]).filter(t=>{const e=this.validateSelector(t);return this.logger?.errorIf(e instanceof Error,e),!0===e}):(n&&this.logger?.error("Every fragment rule must contain an array of containers",this.getDebugInfo()),[]);var e}validateSelector(t){return t.startsWith("#")?!t.match(/\s|>/)||new Error(`fragment selectors must not be nested: ${t}`):new Error(`fragment selectors must be IDs: ${t}`)}getDebugInfo(){const{from:t,to:e,containers:r}=this;return{from:String(t),to:String(e),containers:String(r)}}matches(t,r){if(!this.if(r))return n&&this.logger?.log("ignoring fragment rule due to custom rule.if:",this),!1;const{url:s}=e.Location.fromUrl(t.from),{url:o}=e.Location.fromUrl(t.to);if(!this.matchesFrom(s)||!this.matchesTo(o))return!1;for(const t of this.containers){const e=this.validateFragmentSelectorForMatch(t);if(e instanceof Error)return n&&this.logger?.error(e,this.getDebugInfo()),!1}return!0}validateFragmentSelectorForMatch(t){return document.querySelector(t)?!!v(t,this.swup)||new Error(`skipping rule since ${l(t)} is outside of swup's default containers`):new Error(`skipping rule since ${l(t)} doesn't exist in the current document`)}}const $=function(t){const e=h(t);e&&d(e,this.parsedRules,t)&&(t.scroll.reset=!1)},_=function(t){try{const e=this,r=h(t);if(!r)return Promise.resolve();const s=e.getFragmentVisit(r,t);if(!s)return Promise.resolve();t.fragmentVisit=s,n&&e.logger?.log(`fragment visit: ${l(t.fragmentVisit.containers.join(", "))}`),t.scroll=function(t,e){return"boolean"==typeof t.scroll?{...e,reset:t.scroll}:"string"!=typeof t.scroll||e.target?e:{...e,target:t.scroll}}(s,t.scroll);const o=t.a11y;return void 0!==s.focus&&(n&&e.logger?.errorIf(!o,"Can't set visit.a11y.focus. Is @swup/a11y-plugin installed?"),o&&(o.focus=s.focus)),t.animation.scope=t.fragmentVisit.containers,t.containers=t.fragmentVisit.containers,t.animation.selector=t.fragmentVisit.containers.join(","),p(s,!0),Promise.resolve()}catch(t){return Promise.reject(t)}},R=function(t,e){t.fragmentVisit&&w(t.fragmentVisit)&&(n&&this.logger?.log(`${l("out")}-animation skipped for ${l(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},E=function(t,e){t.fragmentVisit&&w(t.fragmentVisit)&&(n&&this.logger?.log(`${l("in")}-animation skipped for ${l(t.fragmentVisit?.containers.toString())}`),e.skip=!0)},F=function(t,e){if(t.trigger.el||!t.to.url)return;const r=this.swup.cache.get(t.to.url);r&&r.fragmentHtml&&(t.to.document=(new DOMParser).parseFromString(r.fragmentHtml,"text/html"),t.to.html=r.fragmentHtml,n&&this.logger?.log(`fragment cache used for ${l(t.to.url)}`))},b=function(t){p(t.fragmentVisit,!0),u(this),(({swup:t,logger:e})=>{const r=t.getCurrentUrl(),s=t.cache,o=s.get(r);if(!o)return;const i=(new DOMParser).parseFromString(o.html,"text/html"),a=[],c=Array.from(document.querySelectorAll("[data-swup-fragment]")).filter(t=>!t.matches("template")&&!g(t,r));c.length&&(t.options.cache?(c.forEach(t=>{if(null!=t.querySelector("[data-swup-fragment]"))return;const r=t.__swupFragment?.url;if(!r)return void(n&&e?.warn("no fragment url found:",t));const o=t.__swupFragment?.selector;if(!o)return void(n&&e?.warn("no fragment selector found:",t));const l=s.get(r);if(!l)return;const c=i.querySelector(o);if(!c)return;const u=(new DOMParser).parseFromString(l.html,"text/html").querySelector(o);u&&(u.setAttribute("data-swup-fragment-url",r),c.replaceWith(u),a.push(t))}),a.length&&(s.update(r,{fragmentHtml:i.documentElement.outerHTML}),a.forEach(t=>{const r=t.__swupFragment?.url||"",s=t.__swupFragment?.selector||"";n&&e?.log(`updated cache with ${l(s)} from ${l(r)}`)}))):n&&e?.warn("can't cache foreign fragment elements without swup's cache"))})(this)},A=function(t){p(t.fragmentVisit,!1)};module.exports=class extends s.default{get parsedRules(){return this._parsedRules}constructor(t){super(),this.name="SwupFragmentPlugin",this.requires={swup:">=4.6"},this._rawRules=[],this._parsedRules=[],this.options=void 0,this.defaults={rules:[],debug:!1},this.logger=void 0,this.options={...this.defaults,...t}}mount(){const t=this.swup;this.setRules(this.options.rules),n&&this.options.debug&&(this.logger=new c),this.before("link:self",$),this.on("visit:start",_),this.before("animation:out:await",R),this.before("animation:in:await",E),this.before("content:replace",F),this.on("content:replace",b),this.on("visit:end",A),n&&this.logger?.warnIf(!t.options.cache,"fragment caching will only work with swup's cache being active"),u(this)}unmount(){super.unmount(),document.querySelectorAll("[data-swup-fragment]").forEach(t=>{t.removeAttribute("data-swup-fragment-url"),delete t.__swupFragment})}setRules(t){this._rawRules=y(t),this._parsedRules=t.map(t=>this.parseRule(t)),n&&this.logger?.log("Updated fragment rules",this.getRules())}getRules(){return y(this._rawRules)}prependRule(t){this.setRules([t,...this.getRules()])}appendRule(t){this.setRules([...this.getRules(),t])}parseRule(t){return new S({...t,logger:this.logger,swup:this.swup})}getFragmentVisit(t,e){const r=d(t,this.parsedRules,e||this.swup.createVisit(t));if(!r)return;const s=((t,e,r,s)=>{let o=e.map(t=>{const e=document.querySelector(t);return e?v(t,r)?{selector:t,el:e}:(n&&s?.error(`${l(t)} is outside of swup's default containers`),!1):(n&&s?.log(`${l(t)} missing in current document`),!1)}).filter(t=>!!t);const i=o.every(e=>g(e.el,t.to));return f(t.from,t.to)||i&&"navigate"===r.options.linkToSelf||(o=o.filter(e=>!g(e.el,t.to)||(n&&s?.log(`ignoring fragment ${l(e.selector)} as it already matches the current URL`),!1))),o.map(t=>t.selector)})(t,r.containers,this.swup,this.logger);if(!s.length)return;const{name:o,scroll:i,focus:a}=r;return{containers:s,name:o,scroll:i,focus:a}}};
//# sourceMappingURL=index.cjs.map
